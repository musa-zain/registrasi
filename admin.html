<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard Panitia Sholat Idul Fitri</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f8fafc; padding: 20px; color: #1f2937; }
        .container { max-width: 1000px; margin: auto; background: #fff; padding: 25px; border-radius: 16px; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        h2 { color: #065f46; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        
        /* Stats Styling */
        .stats { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .stat-card { background: #f0fdf4; padding: 20px; border-radius: 12px; flex: 1; min-width: 180px; border: 1px solid #d1fae5; text-align: center; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-card span { display: block; font-size: 28px; font-weight: 800; color: #047857; line-height: 1.2; }
        .stat-card label { font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Table Styling */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #eee; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; background: white; }
        th { background: #f9fafb; color: #4b5563; text-transform: uppercase; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; padding: 14px; text-align: left; border-bottom: 2px solid #edf2f7; }
        td { padding: 14px; border-bottom: 1px solid #f3f4f6; }
        tr:hover { background: #f8fafc; }
        
        /* Components */
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; display: inline-block; }
        .hadir { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .belum { background: #fff1f2; color: #991b1b; border: 1px solid #fecaca; }
        
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 11px 18px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-refresh { background: #047857; color: #fff; }
        .btn-refresh:hover { background: #065f46; }
        .btn-csv { background: #1f2937; color: #fff; }
        .btn-csv:hover { background: #111827; }
        
        #loading { text-align: center; padding: 40px; color: #6b7280; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìä Dashboard Panitia 2026</h2>
    
    <div class="stats">
        <div class="stat-card"><span id="totalPeserta">0</span><label>Total Registrasi</label></div>
        <div class="stat-card"><span id="totalJamaah">0</span><label>Total Jamaah (Pax)</label></div>
        <div class="stat-card"><span id="totalHadir">0</span><label>Sudah Check-in</label></div>
    </div>

    <div class="btn-group">
        <button onclick="loadData()" class="btn btn-refresh">üîÑ Refresh Data</button>
        <button onclick="downloadCSV()" class="btn btn-csv">‚¨áÔ∏è Ekspor CSV</button>
    </div>

    <div id="loading">Memuat database peserta...</div>
    
    <div class="table-container">
        <table id="dataTable" style="display:none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nama Lengkap</th>
                    <th>Email</th>
                    <th>No. HP</th>
                    <th>Pax</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwR1HRER1GEdVfa4LlTDXuOhpWoJ5dj6X-dSqgVnURsA0xuFaO6B_f-qUcbJNIb96G4_Q/exec"; // GANTI DENGAN URL ASLI ANDA

    let allData = [];

    async function loadData() {
        const loading = document.getElementById('loading');
        const table = document.getElementById('dataTable');
        loading.style.display = "block";
        table.style.display = "none";
        
        try {
            // Memastikan memanggil action getList yang sesuai backend
            const response = await fetch(`${SCRIPT_URL}?action=getList`);
            const result = await response.json();
            
            if (result.status === "success") {
                allData = result.data;
                renderTable(allData);
            }
        } catch (err) {
            console.error(err);
            alert("Gagal terhubung ke database. Pastikan SCRIPT_URL sudah benar dan izin akses sudah 'Anyone'.");
        } finally {
            loading.style.display = "none";
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        
        let hadirCount = 0;
        let jamaahTotal = 0;
        
        data.forEach(p => {
            // Penyesuaian mapping kolom berdasarkan Code.gs terbaru:
            // p[0]=ID, p[2]=Nama, p[3]=Email, p[5]=NoHP, p[8]=JumlahOrang, p[9]=Status
            const isHadir = p[9] === "Sudah Check-in";
            if (isHadir) hadirCount++;
            
            const pax = parseInt(p[8]) || 1;
            jamaahTotal += pax;
            
            const row = `<tr>
                <td><strong>${p[0]}</strong></td>
                <td>${p[2]}</td>
                <td><small>${p[3]}</small></td>
                <td>${p[5]}</td>
                <td>${pax}</td>
                <td><span class="badge ${isHadir ? 'hadir' : 'belum'}">${p[9]}</span></td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        document.getElementById('totalPeserta').innerText = data.length;
        document.getElementById('totalJamaah').innerText = jamaahTotal;
        document.getElementById('totalHadir').innerText = hadirCount;
        document.getElementById('dataTable').style.display = "table";
    }

    function downloadCSV() {
        if (allData.length === 0) return alert("Tidak ada data untuk diunduh");
        
        let csv = "ID,Nama Lengkap,Email,No HP,Jumlah Orang,Status,Waktu Check-in\n";
        allData.forEach(p => {
            // Mapping kolom: p[0]=ID, p[2]=Nama, p[3]=Email, p[5]=NoHP, p[8]=Jumlah, p[9]=Status, p[10]=Waktu
            csv += `"${p[0]}","${p[2]}","${p[3]}","${p[5]}","${p[8]}","${p[9]}","${p[10]}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Data_Jamaah_IdulFitri_2026_${new Date().getTime()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    window.onload = loadData;
</script>

</body>
</html>
