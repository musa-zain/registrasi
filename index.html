<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pendaftaran Sholat Idul Fitri - Okayama Central Mosque</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:#f1f5f9;
  color:#1e293b;
}
main{padding:40px 16px}
.container{max-width:480px;margin:auto}

.header{text-align:center;margin-bottom:28px}
.header h1{margin:0;font-size:24px;color:#064e3b;font-weight:700}
.header div{font-size:13px;color:#64748b;margin-top:4px}

.card{
  background:#fff;
  padding:28px;
  border-radius:22px;
  border:1px solid #e2e8f0;
}

.field{margin-bottom:22px}
label{
  display:block;
  margin-bottom:6px;
  font-weight:600;
  font-size:12px;
  color:#475569;
  letter-spacing:.04em;
}

.input-wrapper{position:relative; display: flex; gap: 8px;}
.input-wrapper i{
  position:absolute;
  left:16px;
  top:50%;
  transform:translateY(-50%);
  color:#94a3b8;
}

input,select{
  width:100%;
  padding:12px 14px 12px 44px;
  border-radius:14px;
  border:1.5px solid #e2e8f0;
  font-size:14px;
  background:#f8fafc;
}

input:focus,select:focus{
  outline:none;
  border-color:#10b981;
  background:#fff;
}

/* Tombol Kirim OTP */
.btn-otp {
  width: auto;
  padding: 0 15px;
  background: #064e3b;
  font-size: 12px;
  border-radius: 12px;
  white-space: nowrap;
  height: 45px;
}

/* Kolom OTP Box */
#otpBox {
  display: none;
  background: #f0fdf4;
  padding: 16px;
  border-radius: 16px;
  border: 1px dashed #10b981;
  margin-bottom: 20px;
}

input[name="domisili"]{
  padding-top:20px;
  padding-bottom:20px;
}

.hint{
  font-size:12px;
  color:#94a3b8;
  margin-top:6px;
}

.row{display:flex;gap:14px}
.row .field{flex:1}

button{
  width:100%;
  padding:16px;
  background:#059669;
  color:#fff;
  border:none;
  border-radius:16px;
  font-weight:600;
  font-size:15px;
  cursor:pointer;
}
button:disabled{background:#cbd5e1;cursor:not-allowed}

.consent{
  display:flex;
  gap:12px;
  padding:14px;
  background:#f0fdf4;
  border:1px solid #dcfce7;
  border-radius:14px;
  font-size:13px;
}
.consent input{
  width:20px;
  height:20px;
}

.alert{
  display:none;
  background:#fff1f2;
  color:#be123c;
  padding:12px;
  border-radius:12px;
  margin-bottom:18px;
  text-align:center;
  font-size:13px;
}

footer{text-align:center;font-size:12px;color:#94a3b8;padding:28px}

@media(max-width:480px){
  .row{flex-direction:column}
}
</style>
</head>

<body>

<main>
<div class="container">

<div class="alert" id="duplicateAlert"
 data-id="Data ini sudah terdaftar"
 data-en="This data is already registered"
 data-ja="すでに登録されています"></div>

<div class="header">
  <h1 data-id="Pendaftaran Sholat Idul Fitri"
      data-en="Eid Prayer Registration"
      data-ja="参加登録"></h1>
  <div>Okayama Central Mosque</div>
</div>

<div class="card">
<form id="registrationForm">

<div class="field">
<label data-id="Nama Lengkap" data-en="Full Name" data-ja="氏名"></label>
<div class="input-wrapper">
<i class="fas fa-user"></i>
<input name="nama_lengkap" id="nama_lengkap" required
 data-id-ph="Nama sesuai identitas"
 data-en-ph="Name as shown on ID"
 data-ja-ph="身分証通りの氏名">
</div>
</div>

<div class="field">
<label>Email</label>
<div class="input-wrapper">
<i class="fas fa-envelope"></i>
<input type="email" name="email" id="email" required placeholder="contoh@email.com">
<button type="button" class="btn-otp" id="btnSendOTP" onclick="sendOTP()">
    <span data-id="Kirim Kode" data-en="Send Code" data-ja="コード送信"></span>
</button>
</div>
<div class="hint"
 data-id="Kirim kode verifikasi ke email Anda"
 data-en="Send verification code to your email"
 data-ja="メールに確認コードを送信します"></div>
</div>

<div id="otpBox">
    <label data-id="Masukkan Kode OTP" data-en="Enter OTP Code" data-ja="OTPコードを入力"></label>
    <div class="input-wrapper">
        <i class="fas fa-key"></i>
        <input type="text" id="otp_input" maxlength="4" placeholder="1234">
    </div>
    <div class="hint" data-id="Cek Inbox atau Spam email Anda" data-en="Check your Inbox or Spam folder" data-ja="受信トレイまたは迷惑メールを確認してください"></div>
</div>

<div class="field">
<label data-id="Nomor HP" data-en="Phone Number" data-ja="電話番号"></label>
<div class="input-wrapper">
<i class="fas fa-phone"></i>
<input type="tel" name="no_hp" id="no_hp" required placeholder="08012345678">
</div>
</div>

<div class="field">
<label data-id="Domisili" data-en="City / Residence" data-ja="居住地"></label>
<div class="input-wrapper">
<i class="fas fa-map-marker-alt"></i>
<input name="domisili" required
 data-id-ph="Contoh: Okayama-shi, Kita-ku"
 data-en-ph="Example: Okayama-shi, Kita-ku"
 data-ja-ph="例：岡山市北区">
</div>
</div>

<div class="row">
<div class="field">
<label data-id="Usia" data-en="Age" data-ja="年齢"></label>
<div class="input-wrapper">
<i class="fas fa-id-card"></i>
<input type="number" name="usia" required>
</div>
</div>

<div class="field">
<label data-id="Jumlah Orang" data-en="Number of People" data-ja="人数"></label>
<div class="input-wrapper">
<i class="fas fa-users"></i>
<input type="number" name="jumlah_orang" min="1" value="1" required>
</div>
</div>
</div>

<div class="field">
<label data-id="Jenis Kelamin" data-en="Gender" data-ja="性別"></label>
<div class="input-wrapper">
<i class="fas fa-venus-mars"></i>
<select name="jk" required>
<option value="" disabled selected
 data-id="Pilih jenis kelamin"
 data-en="Select gender"
 data-ja="性別を選択"></option>
<option value="Laki-laki" data-id="Laki-laki" data-en="Male" data-ja="男性"></option>
<option value="Perempuan" data-id="Perempuan" data-en="Female" data-ja="女性"></option>
</select>
</div>
</div>

<div class="field">
<label class="consent">
<input type="checkbox" required>
<span data-id="Saya menyetujui data digunakan untuk keperluan acara ini"
      data-en="I agree that my data will be used for this event"
      data-ja="本イベントのために個人情報を使用することに同意します"></span>
</label>
</div>

<button id="submitBtn" disabled
 data-id="Verifikasi Dulu"
 data-en="Verify First"
 data-ja="先に確認してください"></button>

</form>
</div>
</div>
</main>

<footer>© 2026 — Masjid Central Okayama</footer>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzX0vnt3HDczvfrUEenS2mxhsa9GhRFR2I_JBnN7xgsPORswYIlPTEh9zny0D-P5k0x/exec";
const lang=navigator.language.startsWith("ja")?"ja":navigator.language.startsWith("en")?"en":"id";

// Translate UI
document.querySelectorAll("[data-id]").forEach(el=>{ el.textContent=el.dataset[lang]||el.dataset.id; });
document.querySelectorAll("[data-id-ph]").forEach(el=>{ el.placeholder=el.dataset[`${lang}Ph`]||el.dataset.idPh; });

let serverOTP = ""; // Simpan OTP dari server

// 1. KIRIM OTP
async function sendOTP() {
    const emailVal = document.getElementById('email').value;
    const namaVal = document.getElementById('nama_lengkap').value;

    if(!emailVal || !namaVal) {
        alert(lang === "id" ? "Isi Nama dan Email terlebih dahulu" : "Please fill Name and Email first");
        return;
    }

    btnSendOTP.disabled = true;
    btnSendOTP.textContent = "...";

    try {
        const r = await fetch(`${SCRIPT_URL}?action=send_otp&email=${encodeURIComponent(emailVal)}&nama=${encodeURIComponent(namaVal)}`);
        const j = await r.json();
        
        if(j.status === "success") {
            serverOTP = j.otp;
            document.getElementById('otpBox').style.display = 'block';
            alert(lang === "id" ? "Kode OTP terkirim!" : "OTP Code sent!");
            
            // Pasang listener verifikasi otomatis saat ngetik
            document.getElementById('otp_input').oninput = function() {
                if(this.value === serverOTP) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = lang === "ja" ? "登録" : lang === "en" ? "Register" : "Daftar";
                    document.getElementById('otpBox').style.borderColor = "#10b981";
                    document.getElementById('otpBox').style.background = "#f0fdf4";
                    this.disabled = true; // Kunci jika sudah benar
                }
            };
        }
    } catch(e) {
        alert("Gagal kirim OTP");
        btnSendOTP.disabled = false;
    }
}

// 2. CEK DUPLIKAT (Tetap Aktif)
let t;
email.oninput=no_hp.oninput=()=>{
  clearTimeout(t);
  t=setTimeout(async()=>{
   if(email.value&&no_hp.value){
    const r=await fetch(`${SCRIPT_URL}?action=check_duplicate&email=${email.value}&no_hp=${no_hp.value}`);
    const j=await r.json();
    duplicateAlert.style.display=j.isDuplicate?"block":"none";
    if(j.isDuplicate) submitBtn.disabled = true;
   }
  },800);
};

// 3. SUBMIT FINAL
registrationForm.onsubmit=async e=>{
  e.preventDefault();
  submitBtn.disabled=true;

  const original=submitBtn.textContent;
  submitBtn.textContent = "...";

  const fd=new FormData(registrationForm);
  fd.append("action","register");
  fd.append("id","EID-"+Date.now().toString(36).toUpperCase());

  try{
    const r=await fetch(SCRIPT_URL,{method:"POST",body:fd});
    const j=await r.json();
    if(j.status==="success"){
      window.location.href="success.html?"+new URLSearchParams(fd).toString();
    }else{
      alert(j.message);
      submitBtn.disabled=false;
    }
  }catch{
    alert("Koneksi bermasalah");
    submitBtn.disabled=false;
  }
};
</script>

</body>
</html>
