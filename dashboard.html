<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>OCM Bukber 2026 ‚Äì Sistem Panitia</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
<style>
body{margin:0;font-family:Inter,system-ui,sans-serif;background:#020617;color:white}
.hidden{display:none}
button{cursor:pointer}

/* LOGIN */
#login{position:fixed;inset:0;background:#020617;display:flex;align-items:center;justify-content:center;z-index:1000}
.login-box{background:#0f172a;border:1px solid #1e293b;padding:32px;border-radius:20px;width:90%;max-width:340px;text-align:center}
.login-box input{width:100%;padding:14px;margin-top:15px;border-radius:12px;border:1px solid #334155;background:#1e293b;color:white;font-size:16px;text-align:center}
.login-box button{width:100%;margin-top:15px;padding:14px;border-radius:12px;border:none;font-weight:700;font-size:15px}

/* PANITIA DASHBOARD */
#panitia{padding:15px}
.card{background:#0f172a;border:1px solid #1e293b;border-radius:18px;padding:18px;margin-bottom:15px;text-align:center}
.big{font-size:32px;font-weight:800}
.small{font-size:13px;color:#94a3b8}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
#reader{width:100%;max-width:420px;margin:auto;background:black;border-radius:0 0 20px 20px}
.result{padding:20px;border-radius:18px;margin-top:15px;display:none}
.success{background:#059669}
.warning{background:#d97706}
.error{background:#dc2626}
.btn{width:100%;padding:16px;border-radius:14px;border:none;font-size:16px;font-weight:800}
.btn-scan{background:#2563eb;color:white}
.btn-exit{background:#dc2626;color:white}
.status{font-size:12px;color:#cbd5f5;margin-top:8px}

/* ADMIN DASHBOARD */
#admin{background:#f1f5f9;color:#020617;min-height:100vh}
.nav{background:#064e3b;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center}
.container{padding:15px;max-width:1000px;margin:auto}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
.stat{background:white;border-radius:16px;padding:15px;text-align:center}
.stat h2{margin:5px 0;font-size:26px}
table{width:100%;border-collapse:collapse;font-size:13px;background:white;border-radius:16px;overflow:hidden}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
th{background:#f8fafc;text-align:left}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <div class="login-box">
    <div style="font-size:42px">üïå</div>
    <h3>OCM Bukber 2026</h3>
    <input id="adminPass" type="password" placeholder="Password Admin" />
    <button style="background:#059669;color:white" onclick="loginAdmin()">LOGIN ADMIN</button>
    <hr style="margin:15px 0;border-color:#1e293b">
    <button style="background:#2563eb;color:white" onclick="loginPanitiaQR()">SCAN QR PANITIA</button>
    <p id="err" style="color:#f87171;font-size:12px;display:none">Akses ditolak</p>
  </div>
</div>

<!-- PANITIA -->
<div id="panitia" class="hidden">
  <div class="card">
    <div class="big" id="p_hadir">0</div>
    <div class="small">ORANG HADIR</div>
  </div>
  <div class="grid">
    <div class="card"><div class="big" id="p_grup">0</div><div class="small">GRUP SCAN</div></div>
    <div class="card"><div class="big" id="p_belum">0</div><div class="small">BELUM</div></div>
  </div>
  <div class="card">
    <div id="reader"></div>
    <div class="status" id="sys">üü¢ Sistem siap</div>
  </div>
  <div class="result" id="result"></div>
  <button class="btn btn-scan" onclick="restartScan()">SCAN LAGI</button>
  <button class="btn btn-exit" onclick="logout()">KELUAR</button>
</div>

<!-- ADMIN -->
<div id="admin" class="hidden">
  <div class="nav"><b>Dashboard Admin</b><button onclick="logout()" style="background:none;border:none;color:white;font-size:16px">Logout</button></div>
  <div class="container">
    <div class="stats">
      <div class="stat"><h2 id="a_total">0</h2><p>Total Grup</p></div>
      <div class="stat"><h2 id="a_hadir">0</h2><p>Sudah Hadir</p></div>
      <div class="stat"><h2 id="a_belum">0</h2><p>Belum Hadir</p></div>
    </div>
    <br>
    <table>
      <thead><tr><th>ID</th><th>Nama</th><th>Pax</th><th>Status</th><th>Waktu Check-in</th></tr></thead>
      <tbody id="a_table"></tbody>
    </table>
  </div>
</div>

<script>
/* ================= KONFIGURASI ================= */
// GANTI URL INI DENGAN URL WEB APP ANDA
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbZ4GEC-88-LkxGpf2-L7Xjeb_GavD9qq3Uu1qLSSeTTDs3nQQkEmzdGQ-0vNQhfsK/exec';
const ADMIN_PASS = 'ADMINMCO';
const PANITIA_QR = 'PANITIA_BUKBER_2026';
const SESSION_TIMEOUT = 1000 * 60 * 15; // 15 menit

/* ================= VARIABEL GLOBAL ================= */
let lastScanTime = 0;
let sessionTimer;
let html5QrCode = null;
let isScanning = false;

/* ================= FUNGSI UTILITAS ================= */
function startSessionTimer() {
  clearTimeout(sessionTimer);
  sessionTimer = setTimeout(() => {
    alert('Session habis, silakan login ulang');
    logout();
  }, SESSION_TIMEOUT);
}

function resetAll() {
  if (html5QrCode && isScanning) {
    html5QrCode.stop().catch(() => {});
    isScanning = false;
  }
  clearTimeout(sessionTimer);
}

function showError(message) {
  const sys = document.getElementById('sys');
  sys.innerText = `üî¥ ${message}`;
  sys.style.color = '#f87171';
}

function showSuccess(message) {
  const sys = document.getElementById('sys');
  sys.innerText = `üü¢ ${message}`;
  sys.style.color = '#4ade80';
}

/* ================= LOGIN FUNCTIONS ================= */
function loginAdmin() {
  const password = document.getElementById('adminPass').value;
  const err = document.getElementById('err');
  
  if (password !== ADMIN_PASS) {
    err.style.display = 'block';
    setTimeout(() => { err.style.display = 'none'; }, 3000);
    return;
  }
  
  document.getElementById('login').style.display = 'none';
  document.getElementById('admin').classList.remove('hidden');
  loadAdmin();
  startSessionTimer();
}

async function loginPanitiaQR() {
  try {
    document.getElementById('login').style.display = 'none';
    
    // Create QR scanner for login
    const div = document.createElement('div');
    div.id = 'qrlogin';
    div.style.cssText = 'position:fixed;inset:0;background:#020617;text-align:center;z-index:2000;padding-top:50px';
    div.innerHTML = `
      <h3>Scan QR Panitia</h3>
      <p style="font-size:12px;color:#94a3b8;margin-bottom:20px">QR berlaku hari ini</p>
      <div id="qrscan" style="width:300px;height:300px;margin:auto"></div>
      <button onclick="cancelQrLogin()" style="margin-top:20px;background:#dc2626;color:white;border:none;padding:10px 20px;border-radius:10px">Batal</button>
    `;
    document.body.appendChild(div);
    
    const qrLoginScanner = new Html5Qrcode("qrscan");
    
    await qrLoginScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        console.log('QR Login scanned:', decodedText);
        if (decodedText === PANITIA_QR) {
          qrLoginScanner.stop().then(() => {
            div.remove();
            document.getElementById('panitia').classList.remove('hidden');
            startScan();
            loadPanitia();
            startSessionTimer();
          }).catch(() => {});
        } else {
          alert('QR Code tidak valid untuk panitia');
        }
      },
      (errorMessage) => {
        console.log('QR Scanner error:', errorMessage);
      }
    );
    
  } catch (error) {
    console.error("QR Login error:", error);
    alert("Gagal memulai scanner QR");
    document.getElementById('login').style.display = 'flex';
  }
}

function cancelQrLogin() {
  const div = document.getElementById('qrlogin');
  if (div) div.remove();
  document.getElementById('login').style.display = 'flex';
}

function logout() {
  resetAll();
  location.reload();
}

/* ================= PANITIA FUNCTIONS ================= */
async function loadPanitia() {
  try {
    console.log('Loading panitia data from:', SCRIPT_URL);
    
    // Tambahkan timestamp untuk menghindari cache
    const response = await fetch(`${SCRIPT_URL}?action=getList&t=${Date.now()}`, {
      method: 'GET',
      mode: 'no-cors' // Mode no-cors untuk Google Apps Script
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Panitia data received:', data);
    
    if (data.status === 'success') {
      // Perhatikan: field harus sesuai dengan yang dikembalikan backend
      document.getElementById('p_hadir').innerText = data.totalOrangHadir || 0;
      document.getElementById('p_grup').innerText = data.totalHadir || 0;
      document.getElementById('p_belum').innerText = data.belumHadir || 0;
      showSuccess('Online');
    } else {
      showError(`Error: ${data.message || 'Unknown error'}`);
    }
  } catch (error) {
    console.error('Load panitia error:', error);
    showError('Offline - Gagal mengambil data');
    
    // Fallback untuk development
    document.getElementById('p_hadir').innerText = '0';
    document.getElementById('p_grup').innerText = '0';
    document.getElementById('p_belum').innerText = '0';
  }
}

async function startScan() {
  try {
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("reader");
    }
    
    if (isScanning) return;
    
    await html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScanSuccess,
      (errorMessage) => {
        console.log('Scanner error:', errorMessage);
      }
    );
    
    isScanning = true;
    showSuccess('Scanning...');
    
  } catch (error) {
    console.error("Start scan error:", error);
    showError("Gagal memulai kamera");
    setTimeout(startScan, 2000);
  }
}

function onScanSuccess(decodedText) {
  const now = Date.now();
  if (now - lastScanTime < 2000) return; // anti spam
  lastScanTime = now;
  
  if (html5QrCode && isScanning) {
    html5QrCode.pause();
  }
  
  console.log('QR Scanned:', decodedText);
  
  // Gunakan fetch dengan mode 'no-cors' untuk Google Apps Script
  fetch(`${SCRIPT_URL}?action=verifyQR&qrData=${encodeURIComponent(decodedText)}&t=${Date.now()}`)
    .then(response => {
      if (!response.ok) throw new Error('Network error');
      return response.json();
    })
    .then(data => {
      console.log('Verify QR response:', data);
      
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      
      if (data.status === 'success') {
        resultDiv.className = 'result success';
        resultDiv.innerHTML = `<h2>‚úÖ ${data.nama || 'Berhasil'}</h2><p>${data.pax || '0'} Orang</p><small>ID: ${data.id || ''}</small>`;
      } else if (data.status === 'duplicate') {
        resultDiv.className = 'result warning';
        resultDiv.innerHTML = `<h2>‚ö†Ô∏è Sudah Hadir</h2><p>${data.nama || ''}</p>`;
      } else {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = '<h2>‚ùå Tidak Terdaftar</h2>';
      }
      
      // Refresh data setelah scan berhasil
      loadPanitia();
      startSessionTimer();
      
      // Auto resume scanning setelah 3 detik
      setTimeout(() => {
        resultDiv.style.display = 'none';
        if (html5QrCode && isScanning) {
          html5QrCode.resume();
        }
      }, 3500);
      
    })
    .catch(error => {
      console.error('Scan verification error:', error);
      showError('Offline - Coba lagi');
      
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.className = 'result error';
      resultDiv.innerHTML = '<h2>‚ö†Ô∏è Koneksi Error</h2><p>Coba scan lagi</p>';
      
      setTimeout(() => {
        resultDiv.style.display = 'none';
        if (html5QrCode && isScanning) {
          html5QrCode.resume();
        }
      }, 2000);
    });
}

function restartScan() {
  const resultDiv = document.getElementById('result');
  resultDiv.style.display = 'none';
  
  if (html5QrCode && isScanning) {
    html5QrCode.resume();
  }
}

/* ================= ADMIN FUNCTIONS ================= */
async function loadAdmin() {
  try {
    console.log('Loading admin data from:', SCRIPT_URL);
    
    const response = await fetch(`${SCRIPT_URL}?action=getList&t=${Date.now()}`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Admin data received:', data);
    
    if (data.status === 'success') {
      // Update statistics
      document.getElementById('a_total').innerText = data.totalPendaftar || 0;
      document.getElementById('a_hadir').innerText = data.totalHadir || 0;
      document.getElementById('a_belum').innerText = data.belumHadir || 0;
      
      // Update table
      const tableBody = document.getElementById('a_table');
      tableBody.innerHTML = '';
      
      if (data.data && Array.isArray(data.data)) {
        data.data.forEach(row => {
          const tr = document.createElement('tr');
          
          // Format waktu check-in
          let checkinTime = row[10] || '';
          if (checkinTime && checkinTime.includes(' ')) {
            checkinTime = checkinTime.split(' ')[1]; // Ambil hanya jam:menit
          }
          
          tr.innerHTML = `
            <td>${row[0] || ''}</td>
            <td>${row[2] || ''}</td>
            <td>${row[8] || '1'}</td>
            <td>
              <span style="padding: 4px 8px; border-radius: 6px; font-size: 12px; 
                background-color: ${row[9] === 'Sudah Hadir' ? '#dcfce7' : '#fef3c7'}; 
                color: ${row[9] === 'Sudah Hadir' ? '#166534' : '#92400e'};">
                ${row[9] || 'Belum Hadir'}
              </span>
            </td>
            <td>${checkinTime || '-'}</td>
          `;
          tableBody.appendChild(tr);
        });
        
        // Jika tidak ada data, tampilkan pesan
        if (data.data.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px; color: #64748b;">
                Belum ada data pendaftaran
              </td>
            </tr>
          `;
        }
      } else {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px; color: #64748b;">
              Format data tidak valid
            </td>
          </tr>
        `;
      }
    } else {
      alert(`Gagal mengambil data: ${data.message || 'Unknown error'}`);
    }
  } catch (error) {
    console.error('Load admin error:', error);
    alert('Gagal koneksi ke server. Periksa koneksi internet dan URL script.');
    
    // Fallback untuk development
    document.getElementById('a_total').innerText = '0';
    document.getElementById('a_hadir').innerText = '0';
    document.getElementById('a_belum').innerText = '0';
    
    const tableBody = document.getElementById('a_table');
    tableBody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 40px; color: #64748b;">
          Error: ${error.message}
        </td>
      </tr>
    `;
  }
}

/* ================= DEBUGGING HELPERS ================= */
function testConnection() {
  console.log('Testing connection to:', SCRIPT_URL);
  
  fetch(`${SCRIPT_URL}?action=getList&t=${Date.now()}`)
    .then(response => {
      console.log('Response status:', response.status, response.statusText);
      return response.text();
    })
    .then(text => {
      console.log('Raw response:', text);
      try {
        const json = JSON.parse(text);
        console.log('Parsed JSON:', json);
      } catch (e) {
        console.error('Failed to parse JSON:', e);
      }
    })
    .catch(error => {
      console.error('Fetch error:', error);
    });
}

/* ================= INITIALIZATION ================= */
document.addEventListener('DOMContentLoaded', function() {
  console.log('OCM Bukber System Loaded');
  console.log('Script URL:', SCRIPT_URL);
  
  // Test connection saat load
  // testConnection();
  
  // Coba lock orientation untuk mobile
  if (screen.orientation && screen.orientation.lock) {
    screen.orientation.lock('portrait').catch(() => {});
  }
  
  // Reset state saat page load
  resetAll();
});

// Cleanup saat page unload
window.addEventListener('beforeunload', resetAll);

// Export fungsi untuk debugging
window.testConnection = testConnection;
</script>
</body>
</html>
