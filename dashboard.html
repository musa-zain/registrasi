<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>OCM Bukber 2026</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body{margin:0;font-family:system-ui,sans-serif;background:#020617;color:white}
  .hidden{display:none}
  #login{position:fixed;inset:0;background:#020617;display:flex;align-items:center;justify-content:center;z-index:1000}
  .login-box{background:#0f172a;border:1px solid #1e293b;padding:30px;border-radius:20px;width:85%;max-width:320px;text-align:center}
  input{width:100%;padding:12px;margin:10px 0;border-radius:10px;border:1px solid #334155;background:#1e293b;color:white;text-align:center;box-sizing:border-box}
  button{width:100%;padding:12px;border-radius:10px;border:none;font-weight:700;cursor:pointer;margin-top:10px}
  #panitia, #admin{padding:15px}
  .card{background:#0f172a;border:1px solid #1e293b;border-radius:15px;padding:15px;margin-bottom:10px;text-align:center}
  .big{font-size:30px;font-weight:800}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  #reader{width:100%;border-radius:15px;overflow:hidden;background:#000}
  .result{padding:20px;border-radius:15px;margin-top:10px;display:none;text-align:center;font-weight:bold}
  .success{background:#059669}.warning{background:#d97706}.error{background:#dc2626}
  table{width:100%;border-collapse:collapse;font-size:12px;background:white;color:black;border-radius:10px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left}
  th{background:#f1f5f9}
</style>
</head>
<body>

<div id="login">
  <div class="login-box">
    <h2>üïå OCM 2026</h2>
    <input id="adminPass" type="password" placeholder="Password Admin">
    <button style="background:#059669;color:white" onclick="loginAdmin()">MASUK ADMIN</button>
    <button style="background:#2563eb;color:white" onclick="loginPanitia()">SCAN QR PANITIA</button>
  </div>
</div>

<div id="panitia" class="hidden">
  <div class="card"><div class="big" id="p_hadir">0</div><div style="font-size:12px">TOTAL ORANG HADIR</div></div>
  <div class="grid">
    <div class="card"><div class="big" id="p_grup">0</div><div style="font-size:11px">GRUP HADIR</div></div>
    <div class="card"><div class="big" id="p_belum">0</div><div style="font-size:11px">SISA GRUP</div></div>
  </div>
  <div id="reader"></div>
  <div id="result" class="result"></div>
  <button onclick="location.reload()" style="background:#450a0a;color:#f87171">KELUAR</button>
</div>

<div id="admin" class="hidden">
  <div style="display:flex;justify-content:space-between;margin-bottom:15px">
    <b>ADMIN DASHBOARD</b>
    <button onclick="location.reload()" style="width:auto;padding:5px 10px;background:red;color:white">X</button>
  </div>
  <div class="grid">
    <div class="card"><h3 id="a_total">0</h3><p style="font-size:11px">Total Grup</p></div>
    <div class="card"><h3 id="a_hadir">0</h3><p style="font-size:11px">Hadir</p></div>
  </div>
  <table>
    <thead><tr><th>Nama</th><th>Pax</th><th>Waktu</th></tr></thead>
    <tbody id="a_table"></tbody>
  </table>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbySG0uy5r4VC5ubkB6YzVjnEa1Ky7OiqvezdZUm8EymJVaKoUT2knSAWxpMaWAN2O70/exec';
const ADMIN_PASS = 'ADMINMCO';
const PANITIA_QR = 'PANITIA_BUKBER_2026';
let html5QrCode;

function loginAdmin() {
  if(document.getElementById('adminPass').value === ADMIN_PASS) {
    document.getElementById('login').classList.add('hidden');
    document.getElementById('admin').classList.remove('hidden');
    loadData('admin');
  } else { alert("Password Salah"); }
}

function loginPanitia() {
  document.getElementById('login').classList.add('hidden');
  const tempDiv = document.createElement('div');
  tempDiv.id = "temp-scanner";
  tempDiv.style.cssText = "position:fixed;inset:0;background:black;z-index:2000";
  document.body.appendChild(tempDiv);
  
  const scanner = new Html5Qrcode("temp-scanner");
  scanner.start({facingMode:"environment"}, {fps:10, qrbox:250}, (txt) => {
    if(txt === PANITIA_QR) {
      scanner.stop().then(() => {
        tempDiv.remove();
        document.getElementById('panitia').classList.remove('hidden');
        loadData('panitia');
        initMainScanner();
      });
    }
  });
}

function initMainScanner() {
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:250}, onScan);
}

function onScan(txt) {
  html5QrCode.pause();
  const resDiv = document.getElementById('result');
  resDiv.style.display = "block";
  resDiv.className = "result warning";
  resDiv.innerText = "Memproses...";

  fetch(`${SCRIPT_URL}?action=verifyQR&qrData=${encodeURIComponent(txt)}`)
    .then(r => r.json())
    .then(data => {
      if(data.status === 'success') {
        resDiv.className = "result success";
        resDiv.innerHTML = `‚úÖ BERHASIL<br>${data.nama} (${data.pax} Org)`;
      } else if(data.status === 'duplicate') {
        resDiv.className = "result warning";
        resDiv.innerHTML = `‚ö†Ô∏è SUDAH HADIR<br>${data.nama}`;
      } else {
        resDiv.className = "result error";
        resDiv.innerText = "‚ùå TIDAK TERDAFTAR";
      }
      loadData('panitia');
      setTimeout(() => { resDiv.style.display="none"; html5QrCode.resume(); }, 3500);
    }).catch(() => { alert("Koneksi Error"); html5QrCode.resume(); });
}

async function loadData(mode) {
  try {
    const r = await fetch(`${SCRIPT_URL}?action=getList`);
    const d = await r.json();
    if(mode === 'panitia') {
      document.getElementById('p_hadir').innerText = d.totalOrangHadir;
      document.getElementById('p_grup').innerText = d.totalHadir;
      document.getElementById('p_belum').innerText = d.belumHadir;
    } else {
      document.getElementById('a_total').innerText = d.totalPendaftar;
      document.getElementById('a_hadir').innerText = d.totalHadir;
      document.getElementById('a_table').innerHTML = d.data.map(row => 
        `<tr><td>${row[1]}</td><td>${row[2]}</td><td>${row[4]}</td></tr>`
      ).join('');
    }
  } catch(e) { console.log(e); }
}
</script>
</body>
</html>
