<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Check-in Panitia - Sholat Idul Fitri</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: system-ui, sans-serif;
    background: #f8fafc;
    margin: 0;
    display: flex;
    justify-content: center;
}
.container {
    width: 100%;
    max-width: 500px;
    padding: 20px;
}
.header {
    text-align: center;
    color: #065f46;
    margin-bottom: 20px;
}
#reader {
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.result-card {
    background: #fff;
    margin-top: 20px;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    display: none;
}
.status-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: bold;
    margin-bottom: 10px;
}
.success {
    background: #d1fae5;
    color: #065f46;
}
.error {
    background: #fee2e2;
    color: #991b1b;
}
.btn-reset {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    border: none;
    border-radius: 8px;
    background: #047857;
    color: white;
    font-weight: bold;
    cursor: pointer;
}
</style>
</head>

<body>

<div class="container">
    <div class="header">
        <h2>ðŸ“· Scanner Absensi Panitia</h2>
        <p>Arahkan kamera ke QR Code peserta</p>
    </div>

    <div id="reader"></div>

    <div id="resultCard" class="result-card">
        <div id="statusBadge" class="status-badge"></div>

        <p><strong>Nama:</strong> <span id="viewNama">-</span></p>
        <p><strong>ID:</strong> <span id="viewID">-</span></p>
        <p><strong>Jumlah:</strong> <span id="viewJumlah">-</span> Pax</p>

        <button class="btn-reset" onclick="resetScanner()">Scan Lagi</button>
    </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwsnsR41Fs8w7fGW6dmc2oOkVFRNTSFmDguLNHhEt74Pyza8r_J4MTMgVKaz6ekzfFeAg/exec"; // GANTI URL ANDA
let html5QrCode;

// ================= QR SUCCESS =================
function onScanSuccess(decodedText) {
    html5QrCode.pause(true);
    processCheckIn(decodedText);
}

// ================= CHECK-IN PROCESS =================
async function processCheckIn(qrData) {
    const card = document.getElementById("resultCard");
    const badge = document.getElementById("statusBadge");

    card.style.display = "block";
    badge.className = "status-badge";
    badge.innerText = "â³ Memproses...";

    // Reset tampilan
    viewNama.innerText = "-";
    viewID.innerText = "-";
    viewJumlah.innerText = "-";

    try {
        const res = await fetch(
            `${SCRIPT_URL}?action=verifyQR&qrData=${encodeURIComponent(qrData)}`
        ).then(r => r.json());

        // âœ… BERHASIL CHECK-IN
        if (res.status === "success") {
            badge.classList.add("success");
            badge.innerText = "âœ… Berhasil Check-in";

            viewNama.innerText = res.data.nama;
            viewID.innerText = res.data.id;
            viewJumlah.innerText = res.data.pax;

            new Audio("https://www.soundjay.com/buttons/beep-07a.mp3").play();
        }

        // âš ï¸ SUDAH CHECK-IN
        else if (res.status === "duplicate") {
            badge.classList.add("error");
            badge.innerText = "âš ï¸ Sudah Check-in Sebelumnya";

            viewNama.innerText = res.data?.nama || "-";
            viewID.innerText = res.data?.id || "-";
            viewJumlah.innerText = res.data?.pax || "-";
        }

        // âŒ QR RANDOM / TIDAK TERDAFTAR
        else if (res.status === "not_found") {
            badge.classList.add("error");
            badge.innerText = "âŒ Peserta Tidak Terdaftar";
        }

        // âŒ ERROR LAIN
        else {
            badge.classList.add("error");
            badge.innerText = "âŒ QR Tidak Valid";
        }

    } catch (err) {
        badge.classList.add("error");
        badge.innerText = "âŒ Gangguan Koneksi";
    }
}

// ================= RESET =================
function resetScanner() {
    document.getElementById("resultCard").style.display = "none";
    html5QrCode.resume();
}

// ================= CAMERA =================
function startCamera() {
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
    ).catch(err => alert("Kamera error: " + err));
}

window.onload = startCamera;
</script>

</body>
</html>
