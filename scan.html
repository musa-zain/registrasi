<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Check-in Panitia - Sholat Idul Fitri</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  font-family:system-ui,sans-serif;
  background:#f8fafc;
  margin:0;
  display:flex;
  justify-content:center;
}
.container{max-width:500px;width:100%;padding:20px}
.header{text-align:center;color:#065f46;margin-bottom:20px}
#reader{width:100%;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,.1)}
.result-card{
  background:#fff;
  margin-top:20px;
  padding:20px;
  border-radius:12px;
  border:1px solid #e5e7eb;
  display:none;
}
.status-badge{
  display:inline-block;
  padding:6px 14px;
  border-radius:20px;
  font-weight:bold;
  margin-bottom:10px;
}
.success{background:#d1fae5;color:#065f46}
.warning{background:#fef3c7;color:#92400e}
.error{background:#fee2e2;color:#991b1b}
.btn-reset{
  width:100%;
  padding:12px;
  margin-top:15px;
  border:none;
  border-radius:8px;
  background:#047857;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <h2>ðŸ“· Scanner Absensi Panitia</h2>
    <p>Arahkan kamera ke QR Code peserta</p>
  </div>

  <div id="reader"></div>

  <div id="resultCard" class="result-card">
    <div id="statusBadge" class="status-badge"></div>
    <p><strong>Nama:</strong> <span id="viewNama">-</span></p>
    <p><strong>ID:</strong> <span id="viewID">-</span></p>
    <p><strong>Jumlah:</strong> <span id="viewJumlah">-</span> Pax</p>
    <button class="btn-reset" onclick="resetScanner()">Scan Lagi</button>
  </div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwkmGaHISHLF4yWm2jKM_PjVp5ocCyjXReDNS1a1DV-ipj6wDBbz6FnM5bJT0T1NB2dzQ/exec";
let html5QrCode;

/* ========= AUDIO ========= */
const beepSuccess = new Audio("https://www.soundjay.com/buttons/beep-07a.mp3"); // sukses
const beepDuplicate = new Audio("https://www.soundjay.com/buttons/beep-09.mp3"); // warning
const beepInvalid = new Audio("https://www.soundjay.com/buttons/beep-10.mp3"); // error

/* ========= SCAN ========= */
function onScanSuccess(text){
  html5QrCode.pause(true);
  processCheckIn(text);
}

async function processCheckIn(qr){
  resultCard.style.display="block";
  statusBadge.className="status-badge";
  statusBadge.textContent="â³ Memproses...";

  viewNama.textContent="-";
  viewID.textContent="-";
  viewJumlah.textContent="-";

  try{
    const r = await fetch(
      `${SCRIPT_URL}?action=verifyQR&qrData=${encodeURIComponent(qr)}`
    );
    const res = await r.json();

    /* âœ… BERHASIL */
    if(res.status==="success"){
      statusBadge.classList.add("success");
      statusBadge.textContent="âœ… Berhasil Check-in";

      viewNama.textContent=res.data.nama;
      viewID.textContent=res.data.id;
      viewJumlah.textContent=res.data.pax;

      beepSuccess.play();
    }

    /* âš ï¸ DUPLICATE */
    else if(res.status==="duplicate"){
      statusBadge.classList.add("warning");
      statusBadge.textContent="âš ï¸ Sudah Check-in Sebelumnya";

      viewNama.textContent=res.data?.nama||"-";
      viewID.textContent=res.data?.id||"-";
      viewJumlah.textContent=res.data?.pax||"-";

      // bunyi ganda
      beepDuplicate.play();
      setTimeout(()=>beepDuplicate.play(),180);
    }

    /* âŒ TIDAK TERDAFTAR */
    else{
      statusBadge.classList.add("error");
      statusBadge.textContent="âŒ Peserta Tidak Terdaftar";
      beepInvalid.play();
    }

  }catch(e){
    statusBadge.classList.add("error");
    statusBadge.textContent="âŒ Gangguan Koneksi";
    beepInvalid.play();
  }
}

/* ========= RESET ========= */
function resetScanner(){
  resultCard.style.display="none";
  html5QrCode.resume();
}

/* ========= CAMERA ========= */
function startCamera(){
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    {facingMode:"environment"},
    {fps:10, qrbox:250},
    onScanSuccess
  ).catch(err=>alert("Kamera error: "+err));
}

window.onload = startCamera;
</script>

</body>
</html>
